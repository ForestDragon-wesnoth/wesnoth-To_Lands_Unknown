#textdomain wesnoth-To_Lands_Unknown
[scenario]
    id=19_Skydock
    next_scenario=20_Deep_Freeze
    name= _ "Skydock"
    map_data="{~add-ons/To_Lands_Unknown/maps/20_Skydock.map}"
    turns=-1
    victory_when_enemies_defeated=no

	{SCENARIO_MUSIC breaking_the_chains.ogg}
    {MORNING}

    [side]
        side=1
        controller=human
        team_name=mehirteam
        user_team_name= _ "team_name^Mehir"

        type=TLU_Mehir_Leader
        id=Mehir
        name= _ "Mehir"
        unrenamable=yes
        canrecruit=yes
        profile=portraits/mehir-leader.png

        {GOLD 0 0 0}
        {INCOME 10 5 0}

        recruit=EoMa_Water_Elemental,EoMa_Fire_Elemental,EoMa_Water_Avatar,EoMa_Fire_Avatar,EoMa_Rhami,EoMa_RhamiDatu,EoMa_RhamiKai,EoMa_Jinn
    [/side]

    [side]
        side=2
        controller=ai
        team_name=mehirteam
        user_team_name= _ "team_name^Mages"

        type=EoMa_Guru
        id=Guru
        name= _ "Guru"
        unrenamable=yes
        canrecruit=yes
        image_icon="portraits/sky_kingdom/guru.png~CROP(150,10,150,150)~SCALE(72,72)"
        {GOLD 500 700 1200}
        {INCOME 10 5 0}

        ai_algorithm=idle_ai
		
		{UNIT 2 EoMa_Sky_Guardian 9 9 (facing=se)}
		{UNIT 2 EoMa_Sky_Guardian 17 9 (facing=sw)}
		{UNIT 2 EoMa_Sculptor 12 9 (facing,id,image_icon=se,Sculptor,"portraits/sky_kingdom/sculptor.png~CROP(140,45,144,144)~SCALE(72,72)")}
		{UNIT 2 EoMa_Void_Mage 14 9 (facing,id,name,image_icon=sw,Void,"Umbrez","portraits/sky_kingdom/voidmage.png~CROP(110,35,144,144)~SCALE(72,72)")}
    [/side]
	
	[side]
        side=3
        controller=ai
        team_name=enemy
        user_team_name= _ "team_name^Enemy"
        no_leader=yes
        color=black
		hidden=yes

        gold=0
        income=0

		ai_algorithm=idle_ai
    [/side]
	
	{PLACE_HALO "anim/skyship.png" 13 2}
	
	[event]
        name=prestart
		[hide_unit]
			canrecruit=yes
			side=2
		[/hide_unit]
		{RECALL_RASHTI}
	[/event]

	[event]
		name=turn 1
        [message]
            speaker=Void
            message= _ "So you must be Mehir. Come closer, Earthbound."
        [/message]
		{MOVE_UNIT id=Mehir 13 11}
		[message]
            speaker=Mehir
            message= _ "Err.. hello?"
        [/message]
		[message]
            speaker=Sculptor
            message= _ "*to himself* Indeed. Now I understand why Guru wanted us to help this poor little creature..."
        [/message]
		[message]
            speaker=Void
            message= _ "Ah, yes. Guru asked us to improve this n-dimensional quantum waveform pattern around..."
        [/message]
		[message]
            speaker=Void
            message= _ "...you. Oh, you wouldn't understand it anyway. We just need to upgrade your primitive megacircle so it could be more useful instead of being a portable lamp, as it is now."
        [/message]
		[message]
            speaker=Mehir
            message= _ "Well, it is the most powerful kind of equipment available to Summoners. But if you know how to tweak it further then I will gladly accept your help."
        [/message]
		[message]
            speaker=Sculptor
            message= _ "Did he just say this was one of the most advanced things they created?"
        [/message]
		[message]
            speaker=Void
            message= _ "I am afraid the answer is yes."
        [/message]
		[message]
            speaker=Sculptor
            message= _ "Oh, boy... I guess we'd better start working."
        [/message]
		{MOVE_UNIT id=Sculptor 12 10}
		{MOVE_UNIT id=Void 14 10}
		[message]
            speaker=Mehir
            message= _ "Do I have to step out of the circle?"
        [/message]
		[message]
            speaker=Void
            message= _ "This will not be necessary. Although presence of a living body inside the circle during its quasi-modulation could lead to creation of a micro-black hole..."
        [/message]
		[message]
            speaker=Sculptor
            message= _ "...we are professionals."
        [/message]
		[message]
            speaker=Rashti
            message= _ "If this is a trap and my master dies, I will melt both of you in a single blast. There won't be even any ash left."
        [/message]
		[message]
            speaker=Void
            message= _ "Do not worry, abysmal creature. We are capable of handling more complex things than this."
        [/message]
		[message]
            speaker=Mehir
            message= _ "Can I ask you a few questions while you are working on the circle?"
        [/message]
		[message]
            speaker=Void
            message= _ "Of course you can! But you must know this will disturb us in our work, which may result in a mistake and destruction of all space-time continuum. Go on."
        [/message]
		[message]
            speaker=Mehir
            message= _ "Oh.. I understand. I won't ask a lot of questions then. I just want to know the history of your nation. You seem so different from others I have seen during my journey."
        [/message]
		[message]
            speaker=Sculptor
            message= _ "This is a very long story. Well, you could just go to our Library of Enlightment and read about us, but there are 78732 volumes covering the story of both civilizations of Magi. I am afraid you don't have a sufficient amount of spare time for reading all of them."	
        [/message]
		[message]
            speaker=Mehir
            message= _ "Both civilizations? What do you mean?"
        [/message]
		[message]
            speaker=Void
            message= _ "This is little complicated. All you see around you is something we call our 'second civilization'. It is quite young compared to the first one, and much smaller, but at the same time more advanced than ever before. I guess you won't find anyone else on this planet who could raise a billion tons of rock into the sky and build a kingdom on it."
        [/message]
		[message]
            speaker=Mehir
            message= _ "I guess you are right. By the way, why are we not falling down?"
        [/message]
		[message]
            speaker=Void
            message= _ "Because of... magic?"
        [/message]
		[message]
            speaker=Mehir
            message= _ "So how is your nation structured? Who exactly rules this land? Are there any governing bodies?"
        [/message]
		[message]
            speaker=Sculptor
            message= _ "Well, we have the Council of Masters, who organize our society, but it is Guru, who sets long term goals. It was he who came up with the idea of moving our society above clouds. He could theoretically be considered a formal ruler, but the truth is, he cooperates with the Council."	
        [/message]
		[message]
            speaker=Mehir
            message= _ "I see. This Council of yours appears to be similar to our High Council of Elders, but we do not have any Gurus. Are there any conflicts in your society? Who forms law here?"
        [/message]
		[message]
            speaker=Void
            message= _ "Conflicts? Rarely, if any. We are all free, and work togheter to achieve everything we desire. If there is a complex issue, the Council of Masters tries to find a solution with the aid of Guru."
        [/message]
		[message]
            speaker=Mehir
            message= _ "I understand now. This looks like a perfect society. We Summoners could learn so much from you. You mentioned something about the first civilization of Magi. Could you tell us more about it?"
        [/message]
		[message]
            speaker=Void
            message= _ "Oh, did I mention it?"
        [/message]
		[message]
            speaker=Sculptor
            message= _ "Yes you did."
        [/message]
		[message]
            speaker=Void
            message= _ "Well, the First Civilization existed a long time ago. Our roots are truly ancient, dating back thousands of years. In fact, all of us are descendants of that civilization."
        [/message]
		[message]
            speaker=Sculptor
            message= _ "During the reign of the first Magi, our ancestors tried to win their place in a harsh environment. At that time they were not advanced enough to create floating islands, but they were strong enough to create a huge empire and defend themselves."
        [/message]
		[message]
            speaker=Void
            message= _ "At some point, they became one of the most powerful nations on the planet. That was the golden age of Magi. Unfortunately a terrible world-wide cataclysm happened, which led to the fall of the First Civilization. Only a few survived. It took them millenia to rebuild the mage society. But they succeeded, as you can see."
        [/message]
		[message]
            speaker=Void
            message= _ "It looks like I have just summarized 78732 volumes of records about the history of our nation. I am genius!"
        [/message]
		[message]
            speaker=Sculptor
            message= _ "That is why Guru ordered you to upgrade the circle. Now get back to work."
        [/message]
		[message]
            speaker=Void
            message= _ "Whatever you say, boss."
        [/message]
		[message]
            speaker=Sculptor
            message= _ "Very funny..."
        [/message]
		{FADE_TO_BLACK}
		{FADE_IN}
		[message]
            speaker=Sculptor
            message= _ "...just connect these two symbols to proper dimensions and we are good to go."
        [/message]
		[fire_event]
			name=transformation
		[/fire_event]
    [/event]

#define AMLA_REWARD NAME
            [if]
                [have_unit]
			id=Mehir
			ability={NAME}_bonus
                [/have_unit]
                [then]
                  [set_variable]
                      name=expbonus
                      add=80
                  [/set_variable]
                  [set_variable]
                      name=mehir_had_amla
                      value=yes
                  [/set_variable]
                [/then]
           [/if]

#enddef
    [event]
        name=transformation
        {AMLA_REWARD slowingaura}
        {AMLA_REWARD damagingaura}
        {AMLA_REWARD circleres}
		[store_unit]
			[filter]
				id=Mehir
			[/filter]
			variable=mehirvar
		[/store_unit]
        {ADVANCE_UNIT id=Mehir "TLU_The_Last_Summoner"}
		{MODIFY_UNIT id=Mehir profile "portraits/mehir-last.png"}
		{MODIFY_UNIT id=Mehir experience $mehirvar.experience}
		{CLEAR_VARIABLE mehirvar}
        [store_unit]
            [filter]
                id=Mehir
            [/filter]
            variable=mehirnew
        [/store_unit]
        [if]
            [variable]
                name=mehirold.attack[0].damage
                greater_than=$mehirnew.attack[0].damage
            [/variable]
            [then]
                {VARIABLE mehirnew.attack[0].damage $mehirold.attack[0].damage}
            [/then]
        [/if]
        [if]
            [variable]
                name=mehirold.attack[0].number
                greater_than=$mehirnew.attack[0].number
            [/variable]
            [then]
                {VARIABLE mehirnew.attack[0].number $mehirold.attack[0].number}
            [/then]
        [/if]
        [if]
            [variable]
                name=mehirold.max_hitpoints
                greater_than=$mehirnew.max_hitpoints
            [/variable]
            [then]
                {VARIABLE mehirnew.max_hitpoints $mehirold.max_hitpoints}
            [/then]
        [/if]
		[if]
            [variable]
                name=mehirold.attack[1].damage
                greater_than=$mehirnew.attack[1].damage
            [/variable]
            [then]
                {VARIABLE mehirnew.attack[1].damage $mehirold.attack[1].damage}
            [/then]
        [/if]
        [unstore_unit]
            variable=mehirnew
            find_vacant=no
        [/unstore_unit]
		
		[message]
            speaker=Mehir
			image=portraits/mehir-last-happy.png
            message= _ "Whoa! I feel strange energies flowing through my body! It is refreshing!"
        [/message]
		[message]
            speaker=Void
            message= _ "We have enhanced your circle with our magic. Before we start explaining what does what, you need to understand some basics."
        [/message]
		[message]
            speaker=Void
            message= _ "What you people call 'magic' isn't really magic. The truth is, you Summoners do not know magic at all, nor you can learn how to use it."
        [/message]
		[message]
            speaker=Void
            message= _ "But you are lucky to have a stable access to the Abyss. That place, and it's inhabitants, compensate for your weakness. The energy which comes from that dimension is not 'magic' although it acts similarly. Real magic is something entirely different."
        [/message]
		[message]
            speaker=Sculptor
            message= _ "You see, true magic users like us are not bound to magical circles nor are abysmal-creature-dependant. We just use our minds to manipulate the laws of this world. Magic is an unbelievable power which is present exclusively in this realm. You will not witness magic in the Abyss."
        [/message]
		[message]
            speaker=Sculptor
            message= _ "Therefore your magical circle will not work when you reach your people there. But you won't need it there anyway."
        [/message]
		[message]
            speaker=Mehir
            message= _ "Good to know that. I guess I'll just use it to bring the battery. So... what can I expect from this new circle? How can it help me in my task?"
        [/message]
		[message]
            speaker=Void
            message= _ "Well, first of all it has far more powerful attacks than your previous version. It is a miracle you survived so long equipped only with an equivalent of a child's toy."
        [/message]
		[message]
            speaker=Sculptor
            message= _ "But this circle is not only about the higher power output. Apart from that it has two extremely handy features. The first one being the 'damaging aura'."
        [/message]
		[message]
            speaker=Void
            message= _ "That's right. The ultimate circle you are wearing right now can harm and slow all enemies standing close around you. This can be really useful. Let us demonstrate this feature to you, but let's make some space first."
        [/message]
		{MOVE_UNIT id=Sculptor 11 10}
		{MOVE_UNIT id=Void 15 10}
		{MOVE_UNIT id=Rashti 11 12}
		{MODIFY_UNIT id=Sculptor facing se}
		{MODIFY_UNIT id=Void facing sw}
		{MODIFY_UNIT id=Rashti facing ne}
		[message]
            speaker=Sculptor
            message= _ "I'll need six Magical Eyes gathered around you to demonstrate the effects of the damaging aura."
        [/message]
		{FLASH_BLUE ({REPEAT 6 ({UNIT 3 EoMa_Magical_Eye 13 11 (hitpoints=10)})})}
		[message]
            speaker=Sculptor
            message= _ "Good, now wait a few seconds. The circle will track all enemies around you and automatically attack them!"
        [/message]
		[end_turn]
		[/end_turn]
    [/event]
	
	[event]
		name=turn 2
		
		[message]
            speaker=Mehir
			image=portraits/mehir-last-happy.png
            message= _ "Awesome!"
        [/message]
		[message]
            speaker=Void
            message= _ "As you can see, the circle has harmed all hostile beings around you. You didn't even need to think about targeting."
        [/message]
		[message]
            speaker=Mehir
			image=portraits/mehir-last-happy.png
            message= _ "Just as if it acted on its own! It somewhat reminds me of the Living Gate."
        [/message]
		[message]
            speaker=Sculptor
            message= _ "Notice that harmed enemies are also slowed. This can prove extremely useful when used right."
        [/message]
		[message]
            speaker=Void
            message= _ "Let's finish off these Magical Eyes. They are already barely holding togheter. Just wait another few seconds..."
        [/message]
		[end_turn]
		[/end_turn]
	[/event]
	
	[event]
		name=turn 3
		[message]
            speaker=Mehir
			image=portraits/mehir-last-happy.png
            message= _ "This is unbelievable! Nothing in al-Kamija is as good as this!"
        [/message]
		[message]
            speaker=Sculptor
            message= _ "There is another, more amazing feature that needs explanation. Are you ready to listen?"
        [/message]
		[message]
            speaker=Mehir
			image=portraits/mehir-last-happy.png
            message= _ "Of course! I would love to learn more about this masterpiece!"
        [/message]
		[message]
            speaker=Sculptor
            message= _ "As you already know, magical circles can be used to summon creatures from the Abyss. This one can do more than that."
        [/message]
		[message]
            speaker=Mehir
            message= _ "What do you mean?"
        [/message]
		[message]
            speaker=Sculptor
            message= _ "You see, this ultimate megacircle can act like a mobile castle! It can bring your troops to you in an instant."
        [/message]
		[message]
            speaker=Mehir
			image=portraits/mehir-last-shocked.png
            message= _ "You mean I can summon my men? Not only abysmal beings? But how?"
        [/message]
		[message]
            speaker=Void
            message= _ "Your troops will stand on our teleporters connected directly to your circle. When you need a specific unit, your circle will establish a small portal and bring this unit to you directly from our kingdom!"
        [/message]
		[message]
            speaker=Mehir
			image=portraits/mehir-last-happy.png
            message= _ "So it is going to act like city portals in my country! But it is mobile at the same time - this is unbelievable!"
        [/message]
		[message]
            speaker=Sculptor
            message= _ "Indeed. Do you want to test this ability? It turns out all your men are already gathered at the teleport site on the other side of the island. It would be good to bring one of them here."
        [/message]
		[message]
            speaker=Mehir
            message= _ "Yes, I want to see it in action!"
        [/message]
		[message]
            speaker=Void
            message= _ "Good. I hope I used proper magical symbols to make this work. Otherwise a recalled unit of your choosing will transform into a supernova and our entire solar system will vaporize."
        [/message]
		[message]
            speaker=Rashti
            message= _ "*gives him a cold stare*"
        [/message]
		[message]
            speaker=Void
            message= _ "But we are proffesionals, right? Let's verify our theories. Think about recruiting or recalling a specific unit. It should arrive momentairly, I hope..."
        [/message]
		[disallow_end_turn]
		[/disallow_end_turn]
		[store_unit]
			[filter]
				id=Mehir
			[/filter]
			variable=mehirvar
		[/store_unit]
		[fire_event]
			name=forcecastleevent
		[/fire_event]
		[objectives]
            side=1
            [objective]
                description= _ "Recruit or recall something"
                condition=win
            [/objective]
        [/objectives]
	[/event]
	
	#force castle
	[event]
        name=forcecastleevent
        first_time_only=no
		
		#restore old terrain
        [terrain]
            x,y=$keep_new.x,$keep_new.y
            terrain=$keep_new.terrain
        [/terrain]
        {FOREACH castle_new i}
            [terrain]
                x,y=$castle_new[$i].x,$castle_new[$i].y
                terrain=$castle_new[$i].terrain
            [/terrain]
        {NEXT i}

        #create new castle
        [store_locations]
            variable=keep_new
            [filter]
                x,y=$mehirvar.x,$mehirvar.y
            [/filter]
        [/store_locations]

        [if]
            [variable]
                name=keep_new.terrain
                equals=Aa
            [/variable]
            [or]
                [variable]
                    name=keep_new.terrain
                    equals=Urb
                [/variable]
            [/or]
            [or]
                [variable]
                    name=keep_new.terrain
                    equals=Uh
                [/variable]
            [/or]
			[or]
                [variable]
                    name=keep_new.terrain
                    equals=Gg
                [/variable]
            [/or]
            [then]
                [terrain]
                    x,y=$mehirvar.x,$mehirvar.y
                    terrain=$keep_new[$i].terrain|^Kov
                [/terrain]
                [store_locations]
                    variable=castle_new
                    terrain=Aa,Urb,Uh,Gg
                    [and]
                        x,y=$mehirvar.x,$mehirvar.y
                        radius=1
                    [/and]
                    [not]
                        [filter]
                            type=TLU_The_Last_Summoner
                        [/filter]
                    [/not]
                [/store_locations]
                {FOREACH castle_new i}
                    [terrain]
                        x,y=$castle_new[$i].x,$castle_new[$i].y
                        terrain=$castle_new[$i].terrain|^Cov
                    [/terrain]
                {NEXT i}
            [/then]
        [/if]
    [/event]
	
	[event]
		name=recruit,recall
		
		[filter_second]
			side=1
		[/filter_second]
		
		[message]
            speaker=Void
            message= _ "Yes! We are all alive! Hahaha, that was close! The teleport works as expected - you have brought one of your units here. This will work no matter the distance."
        [/message]
		[message]
            speaker=Mehir
			image=portraits/mehir-last-happy.png
            message= _ "Excellent! This is exactly what I need! I can bring my army with me anywhere I want without worrying about logistics! You are genius!"
        [/message]
		[message]
            speaker=Void
            message= _ "Of course we are!"
        [/message]
		[message]
            speaker=Mehir
            message= _ "Does it summon... people taking a bath?"
        [/message]
		[message]
            speaker=Sculptor
            message= _ "Err... what?!"
        [/message]
		[message]
            speaker=Rashti
            message= _ "*facepalm*"
        [/message]
		[message]
            speaker=Mehir
            message= _ "Nevermind, it is good as it is. So what's next?"
        [/message]
		[unhide_unit]
			id=Guru
		[/unhide_unit]
		{MOVE_UNIT id=Guru 9 11}
		[message]
            speaker=Guru
            message= _ "Oh, it looks like your magical circle has been upgraded. Now it actually looks formidable. Good job. You are almost ready to go."
        [/message]
		[message]
            speaker=Guru
            message= _ "But before you set out, we will give you something more. *speaks loudly* Mus! Come here."
        [/message]
		{UNIT 2 EoMa_Mu 1 12 (id,name=Mu,"Mu N2565")}
		{REPEAT 2 ({UNIT 2 EoMa_Mu 1 12 ()})}
		{MOVE_UNIT type=EoMa_Mu 9 11}
		[message]
            speaker=Mu
            message= _ "You called uz, Master?"
        [/message]
		[message]
            speaker=Guru
            message= _ "Yes, you will serve this man here. Now promise you will obey his orders!"
        [/message]
		[message]
            speaker=Mu
            message= _ "We promeeez."
        [/message]
		[message]
            speaker=Mehir
            message= _ "Aren't they too... small for the job? No offence, but I doubt they survive for long in the heat of a battle."
        [/message]
		[message]
            speaker=Guru
            message= _ "In this form they are very fragile, I agree. Don't worry, though, I'll turn them into Ums now. Watch this."
        [/message]
		[message]
            speaker=Guru
            message= _ "..."
            sound=magic-faeriefire.ogg
        [/message]
	[sound]
           name=um.ogg
        [/sound]
		{ADVANCE_UNIT type=EoMa_Mu ""}
	[sound]
           name=um.ogg
        [/sound]
		{MODIFY_UNIT id=Mu name "Um N2565"}
		[message]
            speaker=Mu
            message= _ "Calibration complete. All mystical circuits enabled, orgonal power output nominal. Um N2565 reporting for duty."
        [/message]
		[message]
            speaker=Mehir
			image=portraits/mehir-last-shocked.png
            message= _ "What the... how did they...? They are colossal now!"
        [/message]
		[message]
            speaker=Guru
            message= _ "All Mus can be transformed into a more powerful form called Um. You wouldn't believe how many years we spent experimenting to finally achieve this."
        [/message]
		[message]
            speaker=Guru
            message= _ "Now they are yours. You can use their strength and endurance to your advantage."
        [/message]
		[message]
            speaker=Mehir
            message= _ "Thank you. They will prove useful, I think, although I can't guarantee I will bring them back in one piece."
        [/message]
		[message]
            speaker=Guru
            message= _ "Do not worry. We produce hundreds of them each year."
        [/message]
		[message]
            speaker=Guru
            message= _ "You are all set up now. The skyship will take you to the North Pole. Traveling there by a typical boat would take months."
        [/message]
		[message]
            speaker=Mehir
			image=portraits/mehir-last-happy.png
            message= _ "Nice! I hope we will all fit in. The rest will follow through my circle."
        [/message]
		[message]
            speaker=Guru
            message= _ "Good luck - you will need it."
        [/message]
		{MOVE_UNIT id=Mehir 13 4}
		{MOVE_UNIT id=Rashti 13 5}
		{MOVE_UNIT type=EoMa_Um 13 6}
		[allow_end_turn]
		[/allow_end_turn]
		[endlevel]
            result=victory
			carryover_report=no
			carryover_percentage=100
        [/endlevel]
	[/event]
	
	#refresh moves
	[event]
		name=moveto
		first_time_only=no
		[allow_undo]
		[/allow_undo]
		
		{MODIFY_UNIT id=Mehir moves $mehirvar.max_moves}
	[/event]
	
	#make summoned units loyal
	[event]
		name=prerecruit,prerecall,post advance,post summon
		first_time_only=no
		
		[filter]
			side=1
		[/filter]

		{MODIFY_UNIT side=1 upkeep loyal}
	[/event]
	
	
    {SUMMONER_UNLOCK}
    {ITEM_APPLIER}
    {COLLAR_EVENT}
    {DEATH_MEHIR}
    {I8M20_TERRAIN}
[/scenario]
