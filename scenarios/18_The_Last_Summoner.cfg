#textdomain wesnoth-To_Lands_Unknown
[scenario]
    id=17_The_Last_Summoner
    next_scenario=18_Enlightenment
#    name= _ "The Last Summoner"
    name= _ "Sky Kingdom"
    map_data="{~add-ons/To_Lands_Unknown/maps/18_TheLastSummoner.map}"
    {TURNS 40 35 32}
    victory_when_enemies_defeated=no

    {SCENARIO_MUSIC breaking_the_chains.ogg}
    {EXTRA_SCENARIO_MUSIC traveling_minstrels.ogg}
    {EXTRA_SCENARIO_MUSIC wanderer.ogg}
    {MORNING}

    {STORYTXT_THE_LAST_SUMMONER}

    [side]
        side=1
        controller=human
        team_name=mehirteam
        user_team_name= _ "team_name^Mehir"

        type=TLU_Mehir_Leader
        id=Mehir
        name= _ "Mehir"
        unrenamable=yes
        canrecruit=yes
        profile=portraits/mehir-leader.png

        {GOLD 500 400 300}
#        {INCOME 45 35 25}
        {INCOME 42 35 28}

        recruit=EoMa_Water_Elemental,EoMa_Fire_Elemental,EoMa_Water_Avatar,EoMa_Fire_Avatar,EoMa_Rhami,EoMa_RhamiDatu,EoMa_RhamiKai,EoMa_Jinn
    [/side]

    [side]
        side=2
        controller=ai
        team_name=mages
        user_team_name= _ "team_name^Master of Water"

        type=EoMa_Master_of_Water
        id=MasterWater
        name= _ "Master of Water"
	image_icon=portraits/sky_kingdom/masterofwater.png~CROP(130,20,130,130)~SCALE(72,72)
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Mage_of_Air,EoMa_Subversive_Mage,EoMa_Elementalist,EoMa_Golem,EoMa_Mu,EoMa_Hidden_Face,EoMa_Mage_of_Water,EoMa_Black_Mage,EoMa_Mystic_Warrior,EoMa_Golem_Boss

        {GOLD 125 175 250}
        {INCOME -1 0 1}
		village_gold=0

        [ai]
        [/ai]
    [/side]
    #{LIMIT_CONTEMPORANEOUS_RECRUITS 2 "EoMa_Black_Mage" 2}
    #{LIMIT_CONTEMPORANEOUS_RECRUITS 2 "EoMa_Golem_Boss" 4}

    [side]
        side=3
        controller=ai
        team_name=mages
        user_team_name= _ "team_name^Mage"

        type=EoMa_Mastermage
        id=Mastermage
        name= _ "Mage"
	image_icon=portraits/sky_kingdom/mastermage.png~CROP(165,20,130,130)~SCALE(72,72)
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Mage_of_Air,EoMa_Battlemage,EoMa_Subversive_Mage,EoMa_Golem,EoMa_Mu,EoMa_Hidden_Face,EoMa_War_Mage,EoMa_Sorcerer,EoMa_Mystic_Warrior,EoMa_Cosmic_Eye

#        {GOLD 125 250 325}
        {GOLD 150 225 300}
        {INCOME -1 -0 1}
		village_gold=0

        [ai]
            passive_leader=yes
        [/ai]
    [/side]

    [side]
        side=4
        controller=ai
        team_name=mages
        user_team_name= _ "team_name^Master of Fire"

        type=EoMa_Master_of_Fire
        id=MasterFire
        name= _ "Master of Fire"
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Mage_of_Air,EoMa_Battlemage,EoMa_Mu,EoMa_Hidden_Face,EoMa_Mage_of_Fire,EoMa_Mystic_Warrior,EoMa_Cosmic_Eye

        {GOLD 100 150 200}
#        {INCOME -2 -1 0}
        {INCOME 0 1 2}
		village_gold=0

        [ai]
        [/ai]
    [/side]

    {RASHTI_SIDES 5 6}

#statue of guru:
    [item]
      image="statues/clean/statue-guru.png~FL(horiz)"
      x,y=45,32
    [/item]

    #{STARTING_VILLAGES 2 6}
    #{STARTING_VILLAGES 3 6}
    #{STARTING_VILLAGES 4 6}

    [event]
        name=prestart
		
		{VARIABLE skykingdom yes}
        {SCATTER_UNITS 7 "EoMa_Sorcerer,EoMa_Mystic_Warrior,EoMa_Elementalist,EoMa_Battle_Eye,EoMa_Battlemage" 3 (
            terrain=Gg

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=2
            generate_name=yes
            random_traits=yes

            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        )}
		{SCATTER_UNITS 7 "EoMa_Sorcerer,EoMa_Mystic_Warrior,EoMa_Elementalist,EoMa_Battle_Eye,EoMa_Battlemage" 3 (
#            terrain=Gg

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=3
            generate_name=yes
            random_traits=yes

            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        )}
		{SCATTER_UNITS 7 "EoMa_Sorcerer,EoMa_Mystic_Warrior,EoMa_Elementalist,EoMa_Battle_Eye,EoMa_Battlemage" 3 (
            terrain=Gg

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=4
            generate_name=yes
            random_traits=yes

            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        )}
        [kill]
            side=2,3,4
	    [not]
	      type=EoMa_Magical_Eye,EoMa_Battle_Eye,EoMa_Cosmic_Eye
	    [/not]
	    [filter_location]
	       terrain=Qxu
	    [/filter_location]
	    animate=no
        [/kill]
        {PLACE_HALO "scenery/white.png" 7 30}

        [kill]
            id=Atiros
        [/kill]
        [store_unit]
            [filter]
                side=1
                x,y=recall,recall
            [/filter]
            variable=landing
        [/store_unit]
        {VARIABLE counter 0}
        [disallow_recruit]
            side=1
            type=EoMa_Novice_Summoner,EoMa_Summoner,EoMa_Dispeller,EoMa_Carpet_Rider,EoMa_Camel_Rider
        [/disallow_recruit]
		
		#predefined Sky Kingdom army
        [store_unit]
            [filter]
                side=1
                level=3
				x,y=recall,recall
            [/filter]
            variable=lvls3
        [/store_unit]
		{SCATTER_UNITS $lvls3.length "EoMa_Cosmic_Eye" 3 (

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=3

            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        )}
		{CLEAR_VARIABLE lvls3}
		
#define PORTAL X1 Y1 X2 Y2		
		[tunnel]
			[filter]
			[/filter]
			[source]
				x,y={X1},{Y1}
			[/source]
			[target]
				x,y={X2},{Y2}
			[/target]
		[/tunnel]
#enddef

	#yellow1-yellow2
    {PORTAL 17 32 39 35}
    {PORTAL 18 32 40 35}
    {PORTAL 17 33 39 36}
    {PORTAL 16 32 38 35}

    #blue1-blue2
    {PORTAL 49 18 13 25}

    #white1-white2
    {PORTAL 35 30 9 22}
    {PORTAL 35 31 9 23}

    #orange1-orange2
    {PORTAL 21 8 31 13}
    [/event]

    [event]
        name=start
        {FADE_STEP 225 50}
        {REMOVE_IMAGE 7 30}
        {FADE_STEP 192 5}
        {FADE_STEP 160 5}
        {FADE_STEP 128 5}
        {FADE_STEP 96 5}
        {FADE_STEP 64 5}
        {FADE_STEP 32 5}
        {FADE_STEP 0 5}
		{RECALL_RASHTI}

        [message]
            speaker=Mehir
            image=portraits/mehir-leader-shocked.png
#            message= _ "Amazing. This must be the Land of Magic!"
            message= _ "Unbelievable! I've got to enter heaven to get down into the Abyss."
        [/message]
        [message]
            speaker=Mastermage
#            message= _ "Oh, a Summoner. Interesting... Why are you here? Your countrymen are in the Abyss for good few days."
            message= _ "Oh, a Summoner. Interesting... What are you doing here? Your countrymen are in the Abyss for a good few days."
        [/message]
        [message]
            speaker=Mehir
#            message= _ "I...I am here because of that matter. I didn’t manage to join them on time. I heard that you can help me."
            message= _ "Well, I am here because of that matter. I didn’t quite manage to join them on time. The Kharosians said you know how to get people there without circles. I hope you will offer me your aid."
        [/message]
        {UNIT 3 (EoMa_Shadowmage) () () (id,placement=Agent,leader)}
        [message]
            speaker=Agent
            message= _ "It’s him."
        [/message]
        [message]
            speaker=MasterWater
#            message= _ "Hmmm... so you are Mehir — the leader of Tar-Tabar, defender of Kharos."
            message= _ "Well, well, isn't that Mehir himself — the leader of Tar-Tabar, defender of Kharos?"
        [/message]
        [message]
            speaker=Mehir
#            message= _ "And you look familiar... It was your people who... broke into our catacombs in Ka-Gatta..."
            message= _ "Indeed, as well as the official representative of the High Abysmal Council! Wait... is there something wrong with my eyes, or you look an awful lot like men who broke into our catacombs in Ka-Gatta."
        [/message]
        [message]
            speaker=Mastermage
#            message= _ "We? Oh, you mean the research party led by our flying cartographer Aerius. Well, he was on his own and his pride lost him. Do not blame us for his selfish actions."
            message= _ "Oh, you mean the research party led by Aerius, our flying cartographer? We do not hold responsibility for the collateral damage he may have inflicted. No need to blame us for his actions. Anyway, our Guru knows how to help you. He is in the monumental Palace of Omniscience, but first you must prove yourself worthy visiting him."
        [/message]
#        [message]
#            speaker=Mastermage
#            message= _ "You ask for help. Our Guru knows how to help you. He is in this monumental Palace of Omniscience, but first you must prove yourself worthy visiting him."
#            message= _ "Our Guru knows how to help you. He is in the monumental Palace of Omniscience, but first you must prove yourself worthy visiting him."
#        [/message]
        [message]
            speaker=Mehir
#            message= _ "What do you want me to do?"
#            message= _ "Worthy? Your guru would be well advised to do us a little favor by way of compensation for the harm suffered by your map maker! Besides that, I'm quite a master myself, and immensely knowledgeable. That should do far an audience with your 'all-knowing' higher-up in your kasbah of knowingness!"
            message= _ "I'm not quite sure I understand what you mean."
        [/message]
        [message]
            speaker=MasterWater
#            message= _ "Provide us with a little... entertainment."
            message= _ "Provide us with a little... entertainment."
        [/message]
        [message]
            speaker=Mehir
#            message= _ "What?! You want me to dance or something?"
            message= _ "Entertainment? I'm not quite sure that's my field..."
        [/message]
        [message]
            speaker=Mastermage
#            message= _ "No, of course not. We want you to fight your way to the palace! The army of the Last Summoner against the magi of the Sky Kingdom. The Abyss versus Magic! Two most powerful forces in this world. If you win, you will see the Guru. If you lose, you will be trapped on this planet forever."
            message= _ "You might have got the wrong idea, we challenge you to a contest! Demonstrate your combat prowess by fighting your way through the palace! The last summoners against the magi of the Sky Kingdom! Defeat means for you a stay with us here in heaven - a privilege many a man would gladly die for. What say you to that?"
        [/message]
        [message]
            speaker=Mehir
#            message= _ "But I don’t want to fight you. What if somebody gets killed?"
            message= _ "Does Guru authorize the abuse of his visitors? Presenting myself as the slayer of his underlings would hardly serve my cause. Is this bloodshed truly necessary?"
        [/message]
        [message]
            speaker=Mastermage
#            message= _ "Do not worry about us. We have created this place... and its rules. But if your soldiers die, you will be to blame. Do you accept this challenge, Summoner?"
            message= _ "Pfff... don't worry about us. We have created this place... as well as its rules. But if your soldiers die, well, you will be the one to blame. Do you accept this challenge, Summoner?"
        [/message]
        {BADASS_MODE_CHANGE (
        [message]
            speaker=Mehir
            message= _ "Challenge accepted."
        [/message]
        [message]
            speaker=Mastermage
            message= _ "Excellent! The Guru is waiting for you inside. Good luck, summoner, you'll need it."
        [/message]
	) (
        [message]
            speaker=Mehir
#            message= _ "It looks I have no choice. I must see this Guru of yours, even if this means turning this place into burning rubble."
            message= _ "Seems like I don't have much of a choice. I must see this Guru of yours, even if this means turning this place into burning rubble"
        [/message]
        [message]
            speaker=Mastermage
#            message= _ "Excellent! The Guru is waiting for you inside. Just try to reach the doors."
            message= _ "Excellent! He is waiting for you inside. Good luck, summoner, you'll need it."
        [/message])}
#Mastermage portals
        {FAKE_SCENERY_ANIM scenery/portal 4 20 24 100}
        {PLACE_IMAGE "scenery/portal-small.png" 19 24}
        {PLACE_IMAGE "scenery/portal-small.png" 19 25}
        {PLACE_IMAGE "scenery/portal-small.png" 20 23}
        {PLACE_IMAGE "scenery/portal-small.png" 20 25}
        {PLACE_IMAGE "scenery/portal-small.png" 21 24}
        {PLACE_IMAGE "scenery/portal-small.png" 21 25}
        [item]
        halo=halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(90%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(80%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(70%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(60%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(70%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(80%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(90%):150
        x,y=20,24
        [/item]
#Master of water portals	
        {PLACE_IMAGE "scenery/portal-small.png" 48 27}
        {PLACE_IMAGE "scenery/portal-small.png" 48 28}
        {PLACE_IMAGE "scenery/portal-small.png" 49 27}
        {PLACE_IMAGE "scenery/portal-small.png" 49 29}
        {PLACE_IMAGE "scenery/portal-small.png" 50 27}
        {PLACE_IMAGE "scenery/portal-small.png" 50 28}
        [item]
        halo=halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(90%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(80%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(70%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(60%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(70%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(80%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(90%):150
        x,y=49,28
        [/item]
#Master of fire portals	
        {PLACE_IMAGE "scenery/portal-small.png" 11 11}
        {PLACE_IMAGE "scenery/portal-small.png" 12 10}
        {PLACE_IMAGE "scenery/portal-small.png" 12 11}
        {PLACE_IMAGE "scenery/portal-small.png" 14 10}
        {PLACE_IMAGE "scenery/portal-small.png" 14 11}
        {PLACE_IMAGE "scenery/portal-small.png" 15 11}
        [item]
        halo=halo/fire-aura.png~SCALE(400,320)~GS()~CS(0,64,255)~O(90%):150,halo/fire-aura.png~SCALE(400,320)~GS()~CS(0,64,255)~O(80%):150,halo/fire-aura.png~SCALE(400,320)~GS()~CS(0,64,255)~O(70%):150,halo/fire-aura.png~SCALE(400,320)~GS()~CS(0,64,255)~O(60%):150,halo/fire-aura.png~SCALE(400,320)~GS()~CS(0,64,255)~O(70%):150,halo/fire-aura.png~SCALE(400,320)~GS()~CS(0,64,255)~O(80%):150,halo/fire-aura.png~SCALE(400,320)~GS()~CS(0,64,255)~O(90%):150
        x,y=13,11
        [/item]

        {PLACE_IMAGE "items/gohere.png" 31 8}
        {HIGHLIGHT_IMAGE 31 8 "items/gohere.png" ()}
        {SCROLL_TO 7 36}
	{BADASS_MODE_CHANGE (
	[message]
            speaker=Rashti
            message= _ "Time to slice some airheads into pieces!"
        [/message]
	[message]
            speaker=Mehir
            message= _ "...and preferably add extra salt for flavor."
        [/message]
        ) (
		[message]
            speaker=Mehir
            message= _ "Rashti, are you ready for this?"
        [/message]
		[message]
            speaker=Rashti
            message= _ "I am always ready for anything, Mehir. Why do you ask?"
        [/message]
		[message]
            speaker=Mehir
#            message= _ "I just feel responsible for you after what happened... I would not want anything to happen to you."
            message= _ "I just feel responsible for you after what happened... I can hardly bear the thought of losing you again."
        [/message]
		[message]
            speaker=Rashti
#            message= _ "I know and it is kind of you, but I am immortal now, unlike you. Do not worry about me. It is you who needs protection."
            message= _ "That's nice of you, but I am immortal now. Don't worry about me, you're the one who needs protection."
        [/message]
		[message]
#            speaker=Rashti
#            message= _ "And I think they know how to help us. Otherwise they would ignore us. We just need to pass this test."
            speaker=Rashti
            message= _ "I have no idea what those magi are thinking, but for now we'll have to play along with their weird idea, and hope for the best..."
        [/message]
#        [message]
#            speaker=Mehir
#            message= _ "Troops from the ship should arrive here from time to time, but before it happens I must relay on Rashti and my magical circle."
#        [/message]
         )}
		[message]
            speaker=narrator
            image=halo/jinn-circle2.png
            message= _ "Use teleports to move your troops across the map (they work similarly to the 'teleport' ability. Only teleports of the same color can be teleported between)"
        [/message]

        {VARIABLE magi_death 0}
		
		[micro_ai]
            side=2
            ai_type=simple_attack
            action=add
            ca_score=110000
        [/micro_ai]
		[micro_ai]
            side=3
            ai_type=simple_attack
            action=add
            ca_score=110000
        [/micro_ai]
		[micro_ai]
            side=4
            ai_type=simple_attack
            action=add
            ca_score=110000
        [/micro_ai]

        [objectives]
            side=1
            [objective]
                description= _ "Move Mehir to the Palace of Omniscience"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Mehir"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

	#auto recall
    [event]
        name=new turn
        first_time_only=no

        [if]
            [variable]
                name=turn_number
                equals=1
            [/variable]
            [else]
                {REPEAT 3 (
                    [if]
                        [variable]
                            name=counter
                            less_than_equal_to=$landing.length
                        [/variable]
                        [then]
						  [if]
						    [have_unit]
						       level=2,3,4
						       x,y=recall,recall
						    [/have_unit]
						    [then]
                            [recall]
                                side=1
                                x,y=7,36
								fire_event=yes
								[not]
									level=0
									[or]
										level=1
									[/or]
								[/not]
                            [/recall]
			    			[/then]
			    			[else]
                            	[recall]
                                	side=1
                                	x,y=7,36
									fire_event=yes
                            	[/recall]
			    			[/else]
			    			[/if]
                            {VARIABLE_OP counter add 1}
                        [/then]
                    [/if]
                )}
            [/else]
        [/if]
    [/event]

    #teleports
#define TELEPORT_MACRO OLD_X OLD_Y NEW_X NEW_Y
    [event]
        name=moveto
        first_time_only=no

        [filter]
            x,y={OLD_X},{OLD_Y}
        [/filter]

        [if]
            [have_unit]
                x,y={NEW_X},{NEW_Y}
            [/have_unit]
            [else]
                [sound]
                    name=magic-faeriefire.ogg
                [/sound]
                {TELEPORT_TILE {OLD_X} {OLD_Y} {NEW_X} {NEW_Y}}
                {FAKE_SCENERY_ANIM scenery/transfer 5 {OLD_X} {OLD_Y} 100}
                {SCROLL_TO {NEW_X} {NEW_Y}}
            [/else]
        [/if]
    [/event]
#enddef
#define TELEPORTER X1 Y1 X2 Y2
    {TELEPORT_MACRO {X1} {Y1} {X2} {Y2}}
    {TELEPORT_MACRO {X2} {Y2} {X1} {Y1}}
#enddef

    #yellow1-yellow2
    #{TELEPORTER 17 32 39 35}
    #{TELEPORTER 18 32 40 35}
    #{TELEPORTER 17 33 39 36}
    #{TELEPORTER 16 32 38 35}

    #blue1-blue2
    #{TELEPORTER 49 18 13 25}

    #white1-white2
    #{TELEPORTER 35 30 9 22}

    #orange1-orange2
    #{TELEPORTER 21 8 31 13}

    #victory condition
    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=Mehir
            x,y=31,8
        [/filter]
        [message]
            speaker=Mehir
            message= _ "May I find the solution inside..."
        [/message]

        {CLEAR_VARIABLE magi_death}
        {CLEAR_VARIABLE skykingdom}

        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
            bonus=no
            carryover_report=yes
            linger_mode=no
        [/endlevel]
    [/event]

    [event]
        name=die
        first_time_only=no

        [filter]
            race=human
			[or]
				type=EoMa_Master_of_Fire
			[/or]
        [/filter]
		
		{ANIMHACK magi $x1 $y1 se}
        [if]
            [variable]
                name=magi_death
                equals=0
            [/variable]
            [then]
                [message]
                    speaker=Mehir
#                    message= _ "Huh? What’s going on? He just disappeared!"
                    message= _ "Huh? He just disappeared!"
                [/message]
				[message]
                    speaker=Rashti
                    message= _ "Not exactly. I sense his soul materializing on one of the islands on the horizon. Something must have teleported him there. This place is full of strange energies."
                [/message]
                [message]
                    speaker=Mastermage
#                    message= _ "You see, you cannot kill us here — only slow us down."
                    message= _ "As you can see, you cannot kill us here — only slow us down."
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "I knew you were able to do powerful things like controlling powers of nature, but this... is unbelievable!"
                [/message]
                {VARIABLE magi_death 1}
            [/then]
        [/if]
    [/event]

    [event]
        name=last breath

        [filter]
            id=Mastermage
        [/filter]

        [message]
            speaker=Mastermage
#            message= _ "You are really strong. My time is over here but I think we will meet again. Good luck, Summoner!"
            message= _ "*smirks* Beaten at my own game... Seems like Guru was right to invest so heavily in getting you here. Anyway, my time here is over, so I better go."
        [/message]
    [/event]
	
	#progressive income
	[event]
		name=new turn
		first_time_only=no
		
#define MAGI_INCOME_ADD SIDE ADD
		[store_side]
			side={SIDE}
			variable=currentside
		[/store_side]
		{VARIABLE_OP currentside.income add {ADD}}
		[if]
		{VARIABLE_CONDITIONAL currentside.income greater_than 30}
		[else]
		[modify_side]
			side={SIDE}
			income=$currentside.income
		[/modify_side]
		[/else]
		[/if]
		{CLEAR_VARIABLE currentside}
#enddef
		{MAGI_INCOME_ADD 2 1}
		{MAGI_INCOME_ADD 3 1}
		{MAGI_INCOME_ADD 4 1}
	[/event]
	
	#jinn advice
	[event]
		name=recall,post advance
		id=jinn_advice
		first_time_only=yes
		[filter]
			type=EoMa_Wonderful_Jinn,EoMa_Mystical_Jinn
		[/filter]
		
		[if]
		[have_unit]
			id=$unit.id
			type=EoMa_Wonderful_Jinn
		[/have_unit]
		[then]
			[message]
				speaker=Mehir
				message= _ "Wonderful Jinn! Give me some advice!"
			[/message]
		[/then]
		[else]
			[message]
				speaker=Mehir
				message= _ "Mystical Jinn! Give me some advice!"
			[/message]
		[/else]
		[/if]
		[message]
			speaker=unit
			message= _ "My Master, our enemies are in remote locations connected with teleports. We should take control of these structures as soon as possible and use flying units to weaken their forces."
		[/message]
		[message]
			speaker=unit
#			message= _ "The enemy will play defensive trying to slow us down till their reinformcements arrive. Use your experienced summoners to summon flying units like Jinns and Air Elementals. They can be very useful in a place like this."
			message= _ "The enemy will try to slow us down till their reinforcements arrive. Use your experienced summoners to summon flying units like Jinns and Air Elementals. They are of utmost importance here, as we can't recruit yet."
		[/message]
	[/event]
	
	[event]
		name=enter hex
		[filter]
			side=1
			[filter_location]
				x,y=21,8
				radius=3
			[/filter_location]
			
			[allow_undo]
			[/allow_undo]
		[/filter]
		[message]
			speaker=Mehir
#			message= _ "The entrance to the palace looks suspiciously empty. I might be paranoid, but something tells me there might be an ambush. We should proceed with caution."
			message= _ "The entrance to the palace looks suspiciously empty. We should probably proceed with caution..."
		[/message]
	[/event]
	[event]
		name=enter hex
		[filter]
			side=1
			[filter_location]
				x,y=31,8
				radius=5
			[/filter_location]
			
			[allow_undo]
			[/allow_undo]
		[/filter]

                        {ANIMHACK magi 31 9 se}
			{UNIT 2 EoMa_Sky_Guardian 31 9 (placement,generate_name=map_passable,yes)}
#ifdef EASY
                        {UNIT 2 EoMa_Battle_Eye 29 9 (placement,animate=map_passable,yes)}
			{UNIT 2 EoMa_Battle_Eye 33 9 (placement,animate=map_passable,yes)}
                        {UNIT 2 EoMa_Magical_Eye 30 8 (placement,animate=map_passable,yes)}
			{UNIT 2 EoMa_Magical_Eye 32 8 (placement,animate=map_passable,yes)}
#endif
#ifdef NORMAL
                        {UNIT 2 EoMa_Battle_Eye 29 9 (placement,animate=map_passable,yes)}
			{UNIT 2 EoMa_Battle_Eye 33 9 (placement,animate=map_passable,yes)}
                        {UNIT 2 EoMa_Battle_Eye 30 8 (placement,animate=map_passable,yes)}
			{UNIT 2 EoMa_Battle_Eye 32 8 (placement,animate=map_passable,yes)}
#endif
#ifdef HARD
                        {UNIT 2 EoMa_Cosmic_Eye 29 9 (placement,animate=map_passable,yes)}
			{UNIT 2 EoMa_Cosmic_Eye 33 9 (placement,animate=map_passable,yes)}
                        {UNIT 2 EoMa_Battle_Eye 30 8 (placement,animate=map_passable,yes)}
			{UNIT 2 EoMa_Battle_Eye 32 8 (placement,animate=map_passable,yes)}
#endif

        [/event]
	
	#prevent magi from pushing towards teleports
	
#define FILTER_TELEPORT_LOCATION X1 Y1 X2 Y2
	[not]
		x,y={X1},{Y1}
	[/not]
	[not]
		x,y={X2},{Y2}
	[/not]
#enddef

	[event]
		name=moveto
		first_time_only=no
		[filter]
			side=2,3,4
			[not]
				type=EoMa_Battle_Eye,EoMa_Mage_of_Air,EoMa_Shadowmage,EoMa_Sky_Guardian,EoMa_Cosmic_Eye
			[/not]
			[filter_location]
					{FILTER_TELEPORT_LOCATION 17 32 39 35}
					{FILTER_TELEPORT_LOCATION 18 32 40 35}
					{FILTER_TELEPORT_LOCATION 17 33 39 36}
					{FILTER_TELEPORT_LOCATION 16 32 38 35}
					{FILTER_TELEPORT_LOCATION 49 18 13 25}
					{FILTER_TELEPORT_LOCATION 35 30 9 22}
					{FILTER_TELEPORT_LOCATION 35 31 9 23}
					{FILTER_TELEPORT_LOCATION 21 8 31 13}
			[/filter_location]
		[/filter]
		
		#{MODIFY_UNIT id=$unit.id ai_special guardian}
	[/event]

#teleport animation aplier
	[event]
		name=recruit,recall,attack end,post summon
		id=apply_teleport_anim
		first_time_only=no
		
		[filter]
			[not]
                          ability=teleport
                          [or]
			    type=EoMa_Wonderful_Jinn
                          [/or]
                        [/not]
		[/filter]
		
		[object]
			silent=yes
			duration=forever
			[filter]
				x,y=$x1,$y1
			[/filter]
			[effect]
				apply_to=new_animation
    [animation]
        apply_to=pre_teleport

        start_time=-1200

        teleport_sparkle_1_start_time=-1200
        teleport_sparkle_2_start_time=-1000
        teleport_sparkle_3_start_time=-800

        [teleport_sparkle_1_frame]
            duration=800
            halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
            halo_x=-10
            halo_y=30~-30
        [/teleport_sparkle_1_frame]
        [teleport_sparkle_2_frame]
            duration=800
            halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
            halo_x=0
            halo_y=40~-40
        [/teleport_sparkle_2_frame]
        [teleport_sparkle_3_frame]
            duration=800
            halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
            halo_x=10
            halo_y=30~-30
        [/teleport_sparkle_3_frame]

        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-0.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-1.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-2.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-3.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-4.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-5.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-6.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-7.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-8.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-9.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=200
            image="misc/blank-hex.png"
        [/frame]
    [/animation]
    [animation]
        apply_to=post_teleport
        start_time=-1200

        teleport_sparkle_1_start_time=-1200
        teleport_sparkle_2_start_time=-1000
        teleport_sparkle_3_start_time=-800

        [teleport_sparkle_1_frame]
            duration=800
            halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
            halo_x=10
            halo_y=-30~30
        [/teleport_sparkle_1_frame]
        [teleport_sparkle_2_frame]
            duration=800
            halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
            halo_x=0
            halo_y=-40~40
        [/teleport_sparkle_2_frame]
        [teleport_sparkle_3_frame]
            duration=800
            halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
            halo_x=-10
            halo_y=-30~30
        [/teleport_sparkle_3_frame]
        [frame]
            duration=200
            image="misc/blank-hex.png"
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-9.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-8.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-7.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-6.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-5.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-4.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-3.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-2.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-1.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-0.png~SCALE(144,144))
        [/frame]
    [/animation]
			[/effect]
		[/object]
	[/event]
	[event]
		name=moveto
		id=apply_teleport_anim2
		first_time_only=no
		
		[filter]
			[not]
                          ability=teleport
                          [or]
			    type=EoMa_Wonderful_Jinn
                          [/or]
                        [/not]
		[/filter]
		[allow_undo][/allow_undo]
		[object]
			silent=yes
			duration=forever
			[filter]
				x,y=$x1,$y1
			[/filter]
			[effect]
				apply_to=new_animation
    [animation]
        apply_to=pre_teleport

        start_time=-1200

        teleport_sparkle_1_start_time=-1200
        teleport_sparkle_2_start_time=-1000
        teleport_sparkle_3_start_time=-800

        [teleport_sparkle_1_frame]
            duration=800
            halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
            halo_x=-10
            halo_y=30~-30
        [/teleport_sparkle_1_frame]
        [teleport_sparkle_2_frame]
            duration=800
            halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
            halo_x=0
            halo_y=40~-40
        [/teleport_sparkle_2_frame]
        [teleport_sparkle_3_frame]
            duration=800
            halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
            halo_x=10
            halo_y=30~-30
        [/teleport_sparkle_3_frame]

        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-0.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-1.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-2.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-3.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-4.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-5.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-6.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-7.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-8.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-9.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=200
            image="misc/blank-hex.png"
        [/frame]
    [/animation]
    [animation]
        apply_to=post_teleport
        start_time=-1200

        teleport_sparkle_1_start_time=-1200
        teleport_sparkle_2_start_time=-1000
        teleport_sparkle_3_start_time=-800

        [teleport_sparkle_1_frame]
            duration=800
            halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
            halo_x=10
            halo_y=-30~30
        [/teleport_sparkle_1_frame]
        [teleport_sparkle_2_frame]
            duration=800
            halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
            halo_x=0
            halo_y=-40~40
        [/teleport_sparkle_2_frame]
        [teleport_sparkle_3_frame]
            duration=800
            halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
            halo_x=-10
            halo_y=-30~30
        [/teleport_sparkle_3_frame]
        [frame]
            duration=200
            image="misc/blank-hex.png"
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-9.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-8.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-7.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-6.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-5.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-4.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-3.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-2.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-1.png~SCALE(144,144))
        [/frame]
        [frame]
            duration=100
            image_mod=~MASK(masks/teleport-mask-0.png~SCALE(144,144))
        [/frame]
    [/animation]
			[/effect]
		[/object]
     [/event]		

    {SUMMONER_UNLOCK}
    {ITEM_APPLIER}
    {COLLAR_EVENT}
    {DEATH_MEHIR}
    {I8M18_TERRAIN}
[/scenario]
