#textdomain wesnoth-To_Lands_Unknown
[scenario]
    id=20_Deep_Freeze
    next_scenario=21_Ruins
    name= _ "Deep Freeze"
    map_data="{~add-ons/To_Lands_Unknown/maps/21_DeepFreeze.map}"
    turns=20
    victory_when_enemies_defeated=no

    {SCENARIO_MUSIC into_the_shadows.ogg}
    [time]
        id=dawn_custom
        name= _ "Dawn"
        image=misc/time-schedules/default/schedule-dawn.png
        red=-20
        green=-20
    [/time]

    [event]
        name = preload
        first_time_only = no
        [lua]
            code=<< main = wesnoth.dofile("~add-ons/To_Lands_Unknown/lua/animation.lua") >>
        [/lua]
    [/event]

    {STORYTXT_DEEP_FREEZE}

    [side]
        side=1
        controller=human
        team_name=mehirteam
        user_team_name= _ "team_name^Mehir"

        type=TLU_The_Last_Summoner
        id=Mehir
        name= _ "Mehir"
        unrenamable=yes
        canrecruit=yes
        profile=portraits/mehir-last.png

        {GOLD 800 600 400}
        {INCOME 15 10 5}

        recruit=EoMa_Novice_Summoner,EoMa_Dispeller,EoMa_Dimensional_Gate,EoMa_Dimensional_Gate_II,EoMa_Jinn,EoMa_Rhami,EoMa_Fire_Elemental,EoMa_Water_Elemental,EoMa_Camel_Rider,EoMa_Carpet_Rider,EoMa_Summoner,EoMa_Great_Jinn,EoMa_Efreet,EoMa_Fire_Avatar,EoMa_Water_Avatar,EoMa_Carpet_Master,EoMa_Heavy_Camel_Rider,EoMa_RhamiDatu,EoMa_RhamiKai,EoMa_Air_Elemental,EoMa_Earth_Elemental

        {UNIT 1 (EoMa_Um) 23 6 (placement=leader
upkeep=loyal)}
        {UNIT 1 (EoMa_Um) 24 6 (placement=leader
upkeep=loyal)}
        {UNIT 1 (EoMa_Um) 23 7 (placement=leader
upkeep=loyal)}
    [/side]
    [side]
        side=2
        controller=ai
        team_name=destroyers
        user_team_name= _ "team_name^Unknown"
		no_leader=yes
        hidden=yes
        color=black

        {GOLD 0 0 0}
        {INCOME 0 0 0}

        [ai]
            aggression=1.0
        [/ai]
    [/side]

    {RASHTI_SIDES 3 4}

    [event]
        name=prestart
        {PLACE_HALO "misc/black.png" 15 7}
        {RECALL_RASHTI}
    [/event]

    [event]
        name=start
		
		{SCROLL_TO 30 24}
        {REMOVE_IMAGE 15 7}
		
		[animate_path]
            hex_x=27
            hex_y=24
            image=anim/skyship.png
            x=0,0
            y=36,10
            frames=6
            frame_length=25
            linger=yes
        [/animate_path]
		
		[message]
            speaker=Mehir
            message= _ "Good Nomolas! It..it’s... frrreezing c... c... ccold here!"
        [/message]
		[message]
            speaker=narrator
            caption= _ "Mage"
            image="portraits/mage-pilot.png"
            message=_ "We are at the North Pole, Summoner. Low temperatures are normal in places like this."
        [/message]
		[delay]
			time=500
		[/delay]
        [message]
            speaker=Mehir
            message= _ "So these are the ruins the Guru told us about. They look scary. What happened here?"
        [/message]
		[message]
            speaker=narrator
            caption= _ "Mage"
            image="portraits/mage-pilot.png"
            message=_ "If I told you the whole story, you would freeze to death. In short it was a place of a great battle between two powers. One of them, the Runemasters, perished, though their mechanical creations managed to trap and stop the invaders."
        [/message]
		[message]
            speaker=Mehir
            message= _ "Who were the invaders?"
        [/message]
		[message]
            speaker=narrator
            caption= _ "Mage"
            image="portraits/mage-pilot.png"
            message=_ "Uh... They were extremely powerful, unstoppable, terrifying. Hope you will not meet their remnants here..."
        [/message]
		[message]
            speaker=narrator
            caption= _ "Mage"
            image="portraits/mage-pilot.png"
            message=_ "We have to go now. The battery you are looking for is inside the bunker."
        [/message]
		{SCROLL_TO 28 4}
		[delay]
			time=500
		[/delay]
		{SCROLL_TO 30 24}
		[message]
            speaker=narrator
            caption= _ "Mage"
            image="portraits/mage-pilot.png"
            message=_ "Good luck, Summoner. You will need it."
        [/message]
		[message]
            speaker=Mehir
			image=portraits/mehir-last-angry.png
            message= _ "Hey, wait!"
        [/message]
		{REMOVE_IMAGE 27 24}
		[animate_path]
            hex_x=27
            hex_y=24
            image=anim/skyship.png
            x=0,0
            y=36,-1000
            frames=100
            frame_length=10
        [/animate_path]
		[message]
            speaker=Mehir
            message= _ "Damn it! I have bad feelings about this... "
        [/message]
		[message]
            speaker=Mehir
            message= _ "Let’s move to the bunker. The sooner we get the battery, the less time we spend here."
        [/message]
		{SCROLL_TO 28 4}
		{HIGHLIGHT_IMAGE 28 4 "items/gohere.png" ()}
		[delay]
			time=500
		[/delay]
		{SCROLL_TO 30 24}
		[message]
            speaker=narrator
            image=halo/jinn-circle2.png
            message= _ "Your ultimate circle acts like a moving keep. Use it to recruit or recall units like in a normal keep."
        [/message]
		[message]
            speaker=narrator
            image=halo/jinn-circle2.png
            message= _ "Low temperatures damage your living troops. Use fire elementals to warm them up or use healing units instead. Magical units are not living organisms."
        [/message]
        [if]
            [variable]
                name=mehir_had_amla
                equals=yes
            [/variable]
            [then]
		[message]
                   speaker=narrator
                   image=halo/jinn-circle2.png
                   message= _ "As a Summons Master, Mehir got one or more aura AMLAs (either circle of resistance, damaging aura, or slowing aura). With his new circle, Mehir has all of these abilities automatically. As a compensation, Mehir gets 80 experience points for each of the mentioned AMLAs he obtained."
                [/message]                
        [store_unit]
            [filter]
                id=Mehir
            [/filter]
            variable=mehir
            kill=no   
        [/store_unit]
                  [set_variable]
                      name=mehir.experience
                      add=$expbonus
                  [/set_variable]
			[unstore_unit]
				variable=mehir
				find_vacant=no
				text="+$expbonus| exp"
				red,green,blue=50,50,200
			[/unstore_unit]
			[sound]
                           name=fanfare-short.wav
			[/sound]
            [/then]
        [/if]
        [objectives]
            side=1
            [objective]
                description= _ "Enter the ruins"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Mehir"
                condition=lose
            [/objective]
			{TURNS_RUN_OUT}
        [/objectives]
		
		[store_locations]
            variable=keep_new
            [filter]
				id=Mehir
			[/filter]
        [/store_locations]
        [terrain]
            terrain=Aa^Kov
            [filter]
				id=Mehir
			[/filter]
        [/terrain]

        [if]
            [variable]
                name=keep_new.terrain
                equals=Aa
            [/variable]
            [then]
                [terrain]
                    [filter]
						id=Mehir
					[/filter]
                    terrain=$castle_new[$i].terrain|^Kov
                [/terrain]
                [store_locations]
                    variable=castle_new
                    terrain=Aa
                    [and]
                        [filter]
							id=Mehir
						[/filter]
                        radius=1
                    [/and]
                    [not]
                        [filter]
                            type=TLU_The_Last_Summoner
                        [/filter]
                    [/not]
                [/store_locations]
                {FOREACH castle_new i}
                    [terrain]
                        x,y=$castle_new[$i].x,$castle_new[$i].y
                        terrain=$castle_new[$i].terrain|^Cov
                    [/terrain]
                {NEXT i}
            [/then]
        [/if]
		
		{MODIFY_UNIT side=1 movement_costs.frozen 2}
		{MODIFY_UNIT id=Mehir max_moves 6}
		{MODIFY_UNIT id=Mehir moves 6}
		{MODIFY_UNIT id=Rashti max_moves 6}
		{MODIFY_UNIT id=Rashti moves 6}
    [/event]
	
	[event]
		name=side 1 turn
		first_time_only=no

		#harm human units
		
		[harm_unit]
			[filter]
				race=akhuman
			[/filter]
			{QUANTITY amount 1 2 3}
		[/harm_unit]
	[/event]
	
	#make summoned units loyal
	[event]
		name=prerecruit,prerecall,post advance,post summon
		first_time_only=no
		
		[filter]
			side=1
		[/filter]

		{MODIFY_UNIT side=1 upkeep loyal}
	[/event]
	
	#make summoned ground troops move faster on snow
	[event]
		name=recruit,recall,post advance
		first_time_only=no
		
		[filter]
			side=1
			[not]
				type=EoMa_Dimensional_Gate,EoMa_Dimensional_Gate_II,EoMa_Jinn,EoMa_Carpet_Rider,EoMa_Great_Jinn,EoMa_Wonderful_Jinn,EoMa_Mystical_Jinn,EoMa_Efreet,EoMa_Great_Efreeti,EoMa_Carpet_Master,EoMa_Air_Elemental,EoMa_Air_Avatar,EoMa_Air_God,EoMa_Fire_Avatar,EoMa_Fire_God
			[/not]
		[/filter]
		
		{MODIFY_UNIT (x,y=$x1,$y1) movement_costs.frozen 2}
	[/event]
	
	[event]
		name=recruit,recall,post advance
		first_time_only=no
		
		[filter]
			side=1
			type=EoMa_Dimensional_Gate,EoMa_Dimensional_Gate_II,EoMa_Jinn,EoMa_Carpet_Rider,EoMa_Great_Jinn,EoMa_Wonderful_Jinn,EoMa_Mystical_Jinn,EoMa_Efreet,EoMa_Great_Efreeti,EoMa_Carpet_Master,EoMa_Air_Elemental,EoMa_Air_Avatar,EoMa_Air_God,EoMa_Fire_Avatar,EoMa_Fire_God
		[/filter]
		
		{MODIFY_UNIT (x,y=$x1,$y1) movement_costs.frozen 1}
	[/event]
	
	[event]
		name=turn 2
        [sound]		
           name=roar.ogg
        [/sound]
		[message]
            speaker=Mehir
            message= _ "Did you hear that?"
        [/message]
		[message]
            speaker=Rashti
            message= _ "Yes. I sense something... strange."
        [/message]
		[message]
            speaker=Mehir
            message= _ "Strange? What can be strange for an ultimate being?"
        [/message]
		[message]
            speaker=Rashti
            message= _ "This energy... it is unnatural, yet not artificial. It is ancient, overwhelming, unforgivable... We are not alone here."
        [/message]
		[message]
            speaker=Mehir
            message= _ "I have a bad feeling about this..."
        [/message]
	[/event]
	
	[event]
		name=side 2 turn 2

#ifdef EASY
		{REPEAT 6 (
			{UNIT 2 EoMa_Pirafly 16 26 ()}
		)}
#endif
#ifdef NORMAL
		{REPEAT 9 (
			{UNIT 2 EoMa_Pirafly 16 26 ()}
		)}
#endif
#ifdef HARD
		{REPEAT 12 (
			{UNIT 2 EoMa_Pirafly 16 26 ()}
		)}
#endif
        {SCROLL_TO 16 26}
                [modify_side]
                    side=2
                    hidden=no
                [/modify_side]
		[message]
            speaker=Mehir
            message= _ "What the... There are flying creatures above the water!"
        [/message]
		[message]
            speaker=Rashti
            message= _ "I sense no living creatures here."
        [/message]
	[/event]
	
	[event]
		name=moveto
		[filter]
			side=2
		[/filter]
		
		[message]
            speaker=Mehir
            message= _ "Huh? But they are closing in, fast."
        [/message]
		[message]
            speaker=Rashti
            message= _ "Too fast. Prepare yourselves!"
        [/message]
	[/event]
		
	[event]
		name=turn 3
		
		{REPLACE_SCENARIO_MUSIC northerners.ogg}
		{UNIT 2 (EoMa_Nightmare) 5 12 (find_vacant=yes
animate=yes
facing=se)}
		{SCROLL_TO 5 12}
		[delay]
			time=1000
		[/delay]
		[message]
            speaker=Mehir
			image=portraits/mehir-last-shocked.png
            message= _ "What in the world is that?!"
        [/message]
		{SCROLL_TO 5 12}
		{SCATTER_UNITS 7 "EoMa_Nightmare" 0 (
    x=4-6
    y=11-13
	terrain=Aa
    [not]
        [filter]
        [/filter]
    [/not]
) (side=2
animate=yes
facing=se)}
		[message]
            speaker=Mehir
            message= _ "Damn it. They don’t look friendly. Get ready people!"
        [/message]
	[/event]
	
	[event]
		name=turn 4
		
		[message]
            speaker=Rashti
            message= _ "These beings seem to be magical, but I sense no magic in their bodies. They are not from the Abyss either."
        [/message]
		
		{SCATTER_UNITS 5 "EoMa_Beast,EoMa_Bone_Golem" 0 (
    x=49-51
    y=10-14
	terrain=Aa
    [not]
        [filter]
        [/filter]
    [/not]
) (side=2
animate=yes
facing=sw)}
		[message]
            speaker=Mehir
			image=portraits/mehir-last-shocked.png
            message= _ "What kind of horror is this?!"
        [/message]
		[message]
            speaker=Rashti
            message= _ "These are made of mixed bones. They are so old... This strange power is animating them, but they seem to have minds..."
        [/message]
		{SCATTER_UNITS 7 "EoMa_Cyclops_Skeleton,EoMa_Omen" 0 (
    x=4-6
    y=11-13
	terrain=Aa
    [not]
        [filter]
        [/filter]
    [/not]
) (side=2
animate=yes
facing=se)}
		[message]
            speaker=Mehir
			image=portraits/mehir-last-angry.png
            message= _ "We will soon get surrounded! We’d better get to the entrance as fast as possible!"
        [/message]
	[/event]
	
	#make destroyers fast on snow
	[event]
		name=side 2 turn
		first_time_only=no
		
		{MODIFY_UNIT (side=2
[not]
	[filter_wml]
		movement_type=fly
	[/filter_wml]
[/not]
)movement_costs.frozen 1}
	[/event]
	
	[event]
		name=attack
		
		[filter]
			type=EoMa_Um
		[/filter]
		[filter_second]
			side=2
		[/filter_second]
		[message]
            speaker=unit
            message= _ "Target aquired. Scanning... Destroyer encountered. Threat level: extremely dangerous. Executing pacification protocols."
        [/message]
		[message]
            speaker=Mehir
			image=portraits/mehir-last-shocked.png
            message= _ "A 'destroyer'?! I heard that name recently... Weren't those dark people, who invaded Kharos, worshipping these creatures? This is not good..."
        [/message]
            [set_variable]
                name=destroyers_known
                value=yes
            [/set_variable]
                [modify_side]
                    side=2
                    user_team_name="Destroyers"
                [/modify_side]
	[/event]
	
	[event]
		name=turn 5
	[/event]
	[event]
		name=side 2 turn 6

#ifdef EASY
		{REPEAT 4 (
			{UNIT 2 EoMa_Pirafly 16 26 ()}
		)}
		{REPEAT 2 (
			{UNIT 2 EoMa_Pirania_Monstruosa 16 26 ()}
		)}
#endif
#ifdef NORMAL
		{REPEAT 6 (
			{UNIT 2 EoMa_Pirafly 16 26 ()}
		)}
		{REPEAT 3 (
			{UNIT 2 EoMa_Pirania_Monstruosa 16 26 ()}
		)}
#endif
#ifdef HARD
		{REPEAT 8 (
			{UNIT 2 EoMa_Pirafly 16 26 ()}
		)}
		{REPEAT 4 (
			{UNIT 2 EoMa_Pirania_Monstruosa 16 26 ()}
		)}
#endif
        {SCROLL_TO 16 26}
	[/event]
	
	[event]
		name=attack
		
		[filter]
			type=EoMa_Pirafly,EoMa_Pirania_Monstruosa
		[/filter]
		[filter_second]
			side=1
                        race=akhuman
                [/filter_second]
		[message]
            speaker=unit
            message= _ "*shrieks*"
            sound=hiss-hit.wav
        [/message]
		[message]
            speaker=unit
            message= _ "Aaaaah!"
        [/message]
	[/event]

       [event]
		name=die
		
		[filter]
			race=akhuman
		[/filter]
		[filter_second]
			type=EoMa_Cyclops_Skeleton
		[/filter_second]
		[filter_second_attack]
			special=plague
		[/filter_second_attack]
		
		[message]
            speaker=Mehir
			image=portraits/mehir-last-shocked.png
            message= _ "One of my men! Dear Nomolas! What’s happening to him?!"
        [/message]
		[message]
            speaker=Rashti
            message= _ "This power... it is consuming him. Now his body belongs to them... forever."
        [/message]
		[message]
            speaker=Mehir
			image=portraits/mehir-last-angry.png
            message= _ "We’d better run to this damn bunker before these monsters devour us all!"
        [/message]
	[/event]
	
	#SPAWNING MECHANISM
	[event]
		name=side 2 turn end
		first_time_only=no
		
		[if]
		[variable]
			name=turn_number
			greater_than=4
		[/variable]
		[then]
		{SCATTER_UNITS 3 "EoMa_Cyclops_Skeleton,EoMa_Omen,EoMa_Mara" 0 (
    x=4-6
    y=11-13
	terrain=Aa
    [not]
        [filter]
        [/filter]
    [/not]
) (side=2
animate=yes
facing=se)}
	{SCATTER_UNITS 3 "EoMa_Beast,EoMa_Bone_Golem,EoMa_Punisher" 0 (
    x=49-51
    y=10-14
	terrain=Aa
    [not]
        [filter]
        [/filter]
    [/not]
) (side=2
animate=yes
facing=sw)}
	[/then]
	[/if]
	[/event]
	
	#bunker guards event
	[event]
		name=turn 7
		
		{UNIT 2 (EoMa_Abaddon) 28 4 (animate=yes
ai_special=guardian
facing=se)}
		[message]
            speaker=Mehir
			image=portraits/mehir-last-shocked.png
            message= _ "What... is... THIS?"
        [/message]
		{UNIT 2 (EoMa_Atokpi_General) 27 5 (ai_special=guardian
animate=yes
facing=se)}
		{UNIT 2 (EoMa_Atokpi_General) 28 5 (ai_special=guardian
animate=yes
facing=se)}
		{UNIT 2 (EoMa_Atokpi_General) 29 5 (ai_special=guardian
animate=yes
facing=se)}
		{UNIT 2 (EoMa_Mara) 26 5 (animate=yes
facing=se)}
		{UNIT 2 (EoMa_Mara) 30 5 (animate=yes
facing=se)}
		[message]
            speaker=Mehir
            message= _ "We must clear the path! Hurry!"
        [/message]
	[/event]
	
	[event]
		name=moveto
		
		[filter]
			id=Mehir
			x,y=28,4
		[/filter]
		
		[message]
            speaker=Mehir
			image=portraits/mehir-last-angry.png
            message= _ "Follow me! Hurry!"
        [/message]
		[endlevel]
            result=victory
			carryover_report=no
			carryover_percentage=100
			linger_mode=no
        [/endlevel]
	[/event]
	
	#jinn advice
	[event]
		name=recall,post advance
		first_time_only=yes
		[filter]
			type=EoMa_Wonderful_Jinn,EoMa_Mystical_Jinn
		[/filter]
		
		[if]
		[have_unit]
			id=$unit.id
			type=EoMa_Wonderful_Jinn
		[/have_unit]
		[then]
			[message]
				speaker=Mehir
				message= _ "Wonderful Jinn! Give me some advice!"
			[/message]
		[/then]
		[else]
			[message]
				speaker=Mehir
				message= _ "Mystical Jinn! Give me some advice!"
			[/message]
		[/else]
		[/if]
		{IF_VAR turn_number less_than 3 (
		[then]
		[message]
			speaker=unit
			message= _ "My Master, I sense enemies all around us."
		[/message]
		[message]
			speaker=Mehir
			message= _ "Impossible, this place looks extremely calm and deserted. Tell me more!"
		[/message]
		[message]
			speaker=unit
			message= _ "I need to access parrell dimensions to see opportunities and outcomes. Give me a second, my master..."
		[/message]
		[message]
			speaker=unit
			message= _ "..."
                        sound=magic-faeriefire.ogg
                [/message]
		[message]
			speaker=unit
			message= _ "In about 89.67% of all possible futures I see enemies coming from the west, east and ...south. This will happen really soon. Also, from the entrance of the bunker 4-6 powerful beings will emerge. We will have to mount a heavy strike force to get through."
		[/message] 
		[/then]
		[else]
			[message]
				speaker=unit
				message= _ "My Master, these beings will quickly surround us. We need to rush towards the entrance."
			[/message]
			{IF_VAR turn_number less_than 7 (
			[then]
				[message]
					speaker=unit
					message= _ "Be aware my Master! That bunker will be guarded by 4-6 powerul beings. They will emerge really soon. We will have to mount a heavy strike force to get through."
				[/message]
			[/then]
			)}
		[/else]
		)}
		[message]
			speaker=Mehir
			message= _ "Damn it!"
		[/message]
	[/event]
	
	{I8CUSTOMPLAGUEEVENT}
    {SUMMONER_UNLOCK}
    {ITEM_APPLIER}
    {COLLAR_EVENT}
    {DEATH_MEHIR}
    {I8M21_TERRAIN}
[/scenario]
