#textdomain wesnoth-To_Lands_Unknown
[unit_type]
    id=TLU_The_Last_Summoner
    name= _ "The Last Summoner"
    race=akhuman
    image="units/thelastsummoner.png"
	image_icon=portraits/mehir-last.png~CROP(131,50,130,130)~SCALE(72,72)
    ellipse="misc/ellipse"
    {MAGENTA_IS_THE_TEAM_COLOR}
    hitpoints=82
    movement_type=smallfoot
    movement=5
    experience=180
    level=5
    alignment=lawful
    advances_to=null
    cost=999
    [advancement]
        strict_amla=yes
        max_times=1
        id=AMLA_SPAWNGATES
        description= _ "Mehir spawns a Dimensional Gate II next to him every turn, if there is an vacant hex next to himself, MAX XP +10%"
        image=attacks/blank-attack.png~BLIT(units/summoners-enchanted-ones/gate2.png~SCALE(60,60),0,0)
        [effect]
            apply_to=new_ability
            [abilities]
		[dummy]
			id=tlu_spawndgs
			name= _ "spawns gates"
			description=_"This unit creates a Dimensional Gate II every turn. The gate is spawned adjacent to this unit. If there is no vacant hex around this unit, the ability will not work."
		[/dummy]
            [/abilities]
        [/effect]
        [effect]
            apply_to=max_experience
            increase=10%
        [/effect]
        [effect]
            apply_to=status
            remove=poisoned
        [/effect]
        [effect]
            apply_to=status
            remove=slowed
        [/effect]
    [/advancement]
    [advancement]
        strict_amla=yes
        max_times=100
        id=AMLA_HP
        description= _ "Max HP bonus +8"
        image="misc/icon-amla-tough.png"
        [effect]
            apply_to=hitpoints
            increase_total=8
            heal_full=yes
        [/effect]
        [effect]
            apply_to=status
            remove=poisoned
        [/effect]
        [effect]
            apply_to=status
            remove=slowed
        [/effect]
    [/advancement]
    usage=mixed fighter
    description= _ "The Last Summoner and the most powerful that ever lived..."+{SPECIAL_NOTES}+{SPECIAL_NOTES_MAGICAL}+{SPECIAL_NOTES_ARCANE}+{SPECIAL_NOTES_LEADERSHIP}+{SPECIAL_NOTES_REGENERATES}+{SPECIAL_NOTES_HEALS}+{SPECIAL_NOTES_DRAIN}
    die_sound={SOUND_LIST:HUMAN_DIE}
    [movement_costs]
        sand=1
    [/movement_costs]
    [defense]
        sand=60
    [/defense]
    {DEFENSE_ANIM "units/thelastsummoner-attack-magic1.png" "units/thelastsummonera.png" {SOUND_LIST:HUMAN_OLD_HIT} }
    [resistance]
        blade=90
        pierce=90
        impact=90
        fire=70
        cold=70
        arcane=70
    [/resistance]
    [abilities]
        [regenerate]
            value=8
            id=eoma_healing
            name= _ "ultimate circle"
            description= _ "This unit is equipped with the most powerful kind of magical circle. The owner can recruit and recall units without being in keeps (it doesn’t work in forests). All adjacent friendly units fight better (+125%, +100%, +75%, +50%, +25% — levels 0, 1, 2, 3, 4 respectively), are healed by 8 points, and receive a +20% bonus to their fire, cold, and arcane resistances. At the beginning of each turn, all adjacent enemy units are slowed and receive 8 points of damage."
            affect_self=yes
            poison=cured
        [/regenerate]
        [heals]
            value=8
            id=eoma_healing
            affect_allies=yes
            affect_self=no
            poison=slowed
            [affect_adjacent]
                adjacent=n,ne,se,s,sw,nw
            [/affect_adjacent]
        [/heals]
        [heals]
            affect_allies=yes
            id=eoma_curing
            affect_self=no
            poison=cured
            [affect_adjacent]
                adjacent=n,ne,se,s,sw,nw
            [/affect_adjacent]
        [/heals]
        [leadership]
            id=leadership
            value=125
            cumulative=no
            affect_self=no
            [affect_adjacent]
                adjacent=n,ne,se,s,sw,nw
                [filter]
                    level=0
                [/filter]
            [/affect_adjacent]
        [/leadership]
        [leadership]
            id=leadership
            value=100
            cumulative=no
            affect_self=no
            [affect_adjacent]
                adjacent=n,ne,se,s,sw,nw
                [filter]
                    level=1
                [/filter]
            [/affect_adjacent]
        [/leadership]
        [leadership]
            id=leadership
            value=75
            cumulative=no
            affect_self=no
            [affect_adjacent]
                adjacent=n,ne,se,s,sw,nw
                [filter]
                    level=2
                [/filter]
            [/affect_adjacent]
        [/leadership]
        [leadership]
            id=leadership
            value=50
            cumulative=no
            affect_self=no
            [affect_adjacent]
                adjacent=n,ne,se,s,sw,nw
                [filter]
                    level=3
                [/filter]
            [/affect_adjacent]
        [/leadership]
        [leadership]
            id=leadership
            value=25
            cumulative=no
            affect_self=no
            [affect_adjacent]
                adjacent=n,ne,se,s,sw,nw
                [filter]
                    level=4
                [/filter]
            [/affect_adjacent]
        [/leadership]
        [resistance]
            id=cr
            add=20
            max_value=100
            apply_to=fire,cold,arcane
            affect_self=no
            affect_allies=yes
            [affect_adjacent]
                adjacent=n,ne,se,s,sw,nw
            [/affect_adjacent]
        [/resistance]
    [/abilities]
    [standing_anim]
        start_time=0
        [frame]
            duration=100
            image="units/thelastsummonera.png"
            layer=30
        [/frame]
    [/standing_anim]
    [idle_anim]
        {STANDARD_IDLE_FILTER}
        start_time=0
        [frame]
            duration=200
            image="units/thelastsummoner-attack-magic1.png"
        [/frame]
        [frame]
            duration=800
            image="units/thelastsummoner-attack-magic2.png"
        [/frame]
        [frame]
            duration=150
            image="units/thelastsummoner-attack-magic1.png"
        [/frame]
    [/idle_anim]
    [healing_anim]
        start_time=0
        [frame]
            duration=200
            image="units/thelastsummoner-attack-heal-[1,2,1].png:[200,300,150]"
        [/frame]
    [/healing_anim]
    [recruiting_anim]
        start_time=0
        [filter_second]
            type=EoMa_Dimensional_Gate_II
        [/filter_second]
        [frame]
            image="units/thelastsummoner-attack-magic[1,2,1].png:[200,300,200]"
        [/frame]
    [/recruiting_anim]
    [recruiting_anim]
        start_time=0
        [filter_second]
            type=EoMa_RhamiDatu,EoMa_Mystical_Jinnn
        [/filter_second]
        [frame]
            image="units/thelastsummoner-attack-magic[1,2,1].png:[200,300,200]"
            sound=magic-faeriefire.ogg
        [/frame]
    [/recruiting_anim]
    [recruiting_anim]
        start_time=0
        [filter_second]
            type=EoMa_Efreet,EoMa_DharmaRhami,EoMa_Great_Efreeti
        [/filter_second]
        [frame]
            image="units/thelastsummoner-attack-destr[1,2,1].png:[200,300,200]"
            sound=chaotic-blast.wav
        [/frame]
    [/recruiting_anim]
    [recruiting_anim]
        start_time=0
        [filter_second]
            race=I8 magical
            lvl=1
            [not]
              type=EoMa_Air_Elemental
            [/not]
        [/filter_second]
        [frame]
            duration=200
            image="units/thelastsummoner-attack-heal-[1,2,1].png:[200,300,150]"
        [/frame]
    [/recruiting_anim]
    [recruiting_anim]
        start_time=0
        [frame]
            duration=200
            image="units/thelastsummoner-attack-heal-[1,2,1].png:[200,300,150]"
            sound=magic-faeriefire.ogg
        [/frame]
    [/recruiting_anim]
   [attack]
        name=magical scimitar
        description=_"magical scimitar"
        icon=attacks/scimitar2.png
        type=blade
        range=melee
        damage=10
        number=4
        [specials]
            {WEAPON_SPECIAL_EOMA_PRECISION}
#            {WEAPON_SPECIAL_DRAIN}
        [/specials]
    [/attack]
    [attack]
        name=hammer
        description=_ "magical hammer"
        icon=attacks/hammer-summons.png
        type=impact
        range=melee
        damage=20
        number=2
        [specials]
            {WEAPON_SPECIAL_EOMA_PRECISION}
#            {WEAPON_SPECIAL_DRAIN}
        [/specials]
    [/attack]
    [attack]
        name=circle of destruction
        description=_"circle of destruction"
        icon=attacks/circle-destr.png
        type=fire
        range=ranged
        [specials]
            {WEAPON_SPECIAL_EOMA_ALWAYSHITS}
        [/specials]
        damage=33
        number=1
    [/attack]
    [attack]
        name=scroll
        description=_"scroll spell"
        icon=attacks/scrollspell-mehir.png~FL(horiz)~FL(vert)
        type=pierce
        range=ranged
        [specials]
            {WEAPON_SPECIAL_EOMA_PRECISION}
        [/specials]
        damage=22
        number=2
    [/attack]
    [attack]
        name=incantation of power
        description=_"incantation of power"
        icon=attacks/circle-advance.png
        type=secret
        range=ranged
        [specials]
            {WEAPON_SPECIAL_EOMA_PRECISION}
            {WEAPON_SPECIAL_EOMA_ANTISHIELD}
        [/specials]
        damage=48
        number=1
    [/attack]
    [attack_anim]
        [filter_attack]
            name=magical scimitar
        [/filter_attack]
		start_time=-250
        [frame]
            image="units/thelastsummoner[a,-attack-1,-attack-2,-attack-1,a].png:[50,100*2,50*2]"
        [/frame]
        {SOUND:HIT_AND_MISS {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS} -100}
    [/attack_anim]
    [attack_anim]
        [filter_attack]
            name=hammer
        [/filter_attack]
		start_time=-250
        [frame]
            image="units/thelastsummoner[a,-attack-1,-attack-2,-attack-1,a].png:[50,100*2,50*2]"
        [/frame]
        {SOUND:HIT_AND_MISS mace.wav {SOUND_LIST:MISS} -100}
    [/attack_anim]
	[attack_anim]
        [filter_attack]
            name=scroll
        [/filter_attack]
        missile_start_time=-300
        [if]
            hits=miss
            [missile_frame]
                image="projectiles/flames-n-[3~1].png:[300,75*2]"
                image_diagonal="projectiles/flames-ne-[3~1].png:[300,75*2]"
				image_mod=~GS()~B(255)
                offset=0.0~0.8:300,0.8:75,0.8:75
            [/missile_frame]
        [/if]
        [else]
            hits=yes
            [missile_frame]
                image="projectiles/flames-n-3.png:300"
                image_diagonal="projectiles/flames-ne-3.png"
				image_mod=~GS()~G(128)~B(255)
				sound=spear.ogg
            [/missile_frame]
        [/else]
        start_time=-1000
        [frame]
            image="units/thelastsummoner-attack-heal-[1,2].png:[200,600]"
        [/frame]
        [frame]
            image="units/thelastsummoner-attack-heal-2.png:300"
            sound=fire.wav
        [/frame]
        [frame]
            image="units/thelastsummoner-attack-heal-1.png:150"
            sound=fire.wav
        [/frame]
    [/attack_anim]
#define REDCIRCLE2 VARIATION DIR HALO_X HALO_Y
    [attack_anim]
        [filter_attack]
            name=circle of destruction
        [/filter_attack]
        hits=yes
        direction={DIR}
        [missile_frame]
            begin=-250
            end=0
            offset=1.0
        [/missile_frame]
        [frame]
            begin=-800
            end=-600
            image="units/thelastsummoner-attack-destr1.png"
            halo=halo/circle-destr-{VARIATION}-1.png:100
            halo_x,halo_y={HALO_X},{HALO_Y}
        [/frame]
        [frame]
            begin=-600
            end=-400
            image="units/thelastsummoner-attack-destr1.png"
            halo=halo/circle-destr-{VARIATION}-2.png
            halo_x,halo_y={HALO_X},{HALO_Y}
        [/frame]
        [frame]
            begin=-400
            end=-200
            image="units/thelastsummoner-attack-destr2.png"
            halo=halo/circle-destr-{VARIATION}-3.png
            halo_x,halo_y={HALO_X},{HALO_Y}
        [/frame]
        [frame]
            begin=-200
            end=-50
            image="units/thelastsummoner-attack-destr2.png"
            halo=halo/circle-destr-{VARIATION}-4.png
            halo_x,halo_y={HALO_X},{HALO_Y}
        [/frame]
        [frame]
            begin=-50
            end=150
            image="units/thelastsummoner-attack-destr2.png"
            halo=halo/circle-destr-{VARIATION}-5.png
            halo_x,halo_y={HALO_X},{HALO_Y}
            sound=lightning.ogg
        [/frame]
        [frame]
            begin=150
            end=200
            image="units/thelastsummoner-attack-destr1.png"
            halo=halo/circle-destr-{VARIATION}-4.png
            halo_x,halo_y={HALO_X},{HALO_Y}
        [/frame]
    [/attack_anim]
#enddef
    {REDCIRCLE2 1 n 0 -36}
    {REDCIRCLE2 2 s 0 36}
    {REDCIRCLE2 4 ne 27 -18}
    {REDCIRCLE2 4 nw 27 -18}
    {REDCIRCLE2 3 se 27 18}
    {REDCIRCLE2 3 sw 27 18}
#define CIRCLE2 VARIATION DIR HALO_X HALO_Y
    [attack_anim]
        [filter_attack]
            name=incantation of power
        [/filter_attack]
        hits=yes
        direction={DIR}
        [missile_frame]
            begin=-250
            end=0
            offset=1.0
        [/missile_frame]
        [frame]
            begin=-600
            end=-500
            image="units/thelastsummoner-attack-magic1.png"
            halo=halo/circle-advance-{VARIATION}-4.png:100
            halo_x,halo_y={HALO_X},{HALO_Y}
        [/frame]
        [frame]
            begin=-500
            end=0
            image="units/thelastsummoner-attack-magic1.png"
            halo=halo/circle-advance-{VARIATION}-1.png
            halo_x,halo_y={HALO_X},{HALO_Y}
            sound=lightning.ogg
        [/frame]
        [frame]
            begin=0
            end=200
            image="units/thelastsummoner-attack-magic2.png"
            halo=halo/circle-advance-{VARIATION}-2.png
            halo_x,halo_y={HALO_X},{HALO_Y}
        [/frame]
        [frame]
            begin=200
            end=300
            image="units/thelastsummoner-attack-magic2.png"
            halo=halo/circle-advance-{VARIATION}-3.png
            halo_x,halo_y={HALO_X},{HALO_Y}
        [/frame]
        [frame]
            begin=300
            end=400
            image="units/thelastsummoner-attack-magic2.png"
            halo=halo/circle-advance-{VARIATION}-4.png
            halo_x,halo_y={HALO_X},{HALO_Y}
        [/frame]
        [frame]
            begin=400
            end=600
            image="units/thelastsummoner-attack-magic1.png"
            halo=halo/circle-advance-{VARIATION}-5.png
            halo_x,halo_y={HALO_X},{HALO_Y}
        [/frame]
    [/attack_anim]
    [attack_anim]
        [filter_attack]
            name=incantation of power
        [/filter_attack]
        hits=no
        direction={DIR}
        [missile_frame]
            begin=-250
            end=0
            offset=1.0
        [/missile_frame]
        [frame]
            begin=-600
            end=-500
            image="units/thelastsummoner-attack-magic1.png"
            halo=halo/circle-advance-{VARIATION}-4.png:100
            halo_x,halo_y={HALO_X},{HALO_Y}
        [/frame]
        [frame]
            begin=-500
            end=-300
            image="units/thelastsummoner-attack-magic1.png"
            halo=halo/circle-advance-{VARIATION}-2.png
            halo_x,halo_y={HALO_X},{HALO_Y}
            sound=lightning.ogg
        [/frame]
        [frame]
            begin=-300
            end=-200
            image="units/thelastsummoner-attack-magic2.png"
            halo=halo/circle-advance-{VARIATION}-5.png
            halo_x,halo_y={HALO_X},{HALO_Y}
        [/frame]
        [frame]
            begin=-200
            end=-100
            image="units/thelastsummoner-attack-magic2.png"
            halo=halo/circle-advance-{VARIATION}-4.png
            halo_x,halo_y={HALO_X},{HALO_Y}
        [/frame]
        [frame]
            begin=-100
            end=0
            image="units/thelastsummoner-attack-magic2.png"
            halo=halo/circle-advance-{VARIATION}-5.png
            halo_x,halo_y={HALO_X},{HALO_Y}
        [/frame]
    [/attack_anim]
#enddef
    # The three variations for the north direction:
    {CIRCLE2 1 n 0 -430}
    # The three variations for the south direction:
    {CIRCLE2 1 s 0 -326}
    # And so on...
    {CIRCLE2 1 ne 54 -404}
    {CIRCLE2 1 nw 54 -404}
    {CIRCLE2 1 se 54 -352}
    {CIRCLE2 1 sw 54 -352}
	[extra_anim]
	flag=spawn_dg
        [frame]
            image="units/thelastsummoner-attack-magic[1,2,1].png:[200,300,200]"
        [/frame]
	[/extra_anim]

    #moving castle event
    [event]
        name=moveto
        first_time_only=no
        [filter]
            type=TLU_The_Last_Summoner
        [/filter]

        #restore old terrain
        [terrain]
            x,y=$keep_new.x,$keep_new.y
            terrain=$keep_new.terrain
        [/terrain]
        {FOREACH castle_new i}
            [terrain]
                x,y=$castle_new[$i].x,$castle_new[$i].y
                terrain=$castle_new[$i].terrain
            [/terrain]
        {NEXT i}

        #create new castle
        [store_locations]
            variable=keep_new
            [filter]
                x,y=$x1,$y1
            [/filter]
        [/store_locations]

        [if]
            [variable]
                name=keep_new.terrain
                equals=Aa
            [/variable]
            [or]
                [variable]
                    name=keep_new.terrain
                    equals=Urb
                [/variable]
            [/or]
            [or]
                [variable]
                    name=keep_new.terrain
                    equals=Uh
                [/variable]
            [/or]
			[or]
                [variable]
                    name=keep_new.terrain
                    equals=Gg
                [/variable]
            [/or]
            [then]
                [terrain]
                    x,y=$x1,$y1
                    terrain=$keep_new.terrain|^Kov
                [/terrain]
                [store_locations]
                    variable=castle_new
                    terrain=Aa,Urb,Uh,Gg
                    [and]
                        x,y=$x1,$y1
                        radius=1
                    [/and]
                    [not]
                        [filter]
                            type=TLU_The_Last_Summoner
                        [/filter]
                    [/not]
                [/store_locations]
                {FOREACH castle_new i}
                    [terrain]
                        x,y=$castle_new[$i].x,$castle_new[$i].y
                        terrain=$castle_new[$i].terrain|^Cov
                    [/terrain]
                {NEXT i}
            [/then]
        [/if]
    [/event]

    #damaging aura
    [event]
        name=new turn
        first_time_only=no
		
        [store_unit]
            [filter]
                [filter_adjacent]
                    type=TLU_The_Last_Summoner
                    is_enemy=yes
                [/filter_adjacent]
            [/filter]
            variable=harm
        [/store_unit]
        {FOREACH harm i}
            {VARIABLE harm[$i].status.slowed yes}
            {VARIABLE_OP harm[$i].hitpoints sub 8}
			[animate_unit]
				flag=attack
				[filter]
					type=TLU_The_Last_Summoner
				[/filter]
				[primary_attack]
					name=incantation of power
				[/primary_attack]
				hits=no
				[facing]
					[filter]
						x,y=$harm[$i].x,$harm[$i].y
					[/filter]
				[/facing]
			[/animate_unit]
            [if]
                [variable]
                    name=harm[$i].hitpoints
                    less_than_equal_to=0
                [/variable]
                [then]
                    [kill]
                        x,y=$harm[$i].x,$harm[$i].y
                        fire_event=yes
                        animate=yes
                    [/kill]
                [/then]
                [else]
                    [unstore_unit]
                        find_vacant=no
                        variable=harm[$i]
                        text=_ "8"
                        {COLOR_HARM}
                    [/unstore_unit]
                [/else]
            [/if]
        {NEXT i}
        {CLEAR_VARIABLE harm}
    [/event]
	[event]
		name=side turn
		id=mehirgate_spawn_event1
		first_time_only=no
		
		[store_unit]
   			[filter]
				type=TLU_The_Last_Summoner
 				ability=tlu_spawndgs
			[/filter]
			variable=mehirgate
		[/store_unit]
		
		{IF_VAR side_number equals $mehirgate.side (
		[then]		
			[store_locations]
				[and]
					x,y=$mehirgate.x,$mehirgate.y
					radius=1
				[/and]
				[not]
					[filter]
					[/filter]
				[/not]
				variable=mehirgateloc
			[/store_locations]
			{IF_VAR mehirgateloc.length greater_than 0 (
				[then]
					[animate_unit]
						flag=spawn_dg
						[filter]
							type=TLU_The_Last_Summoner
							ability=tlu_spawndgs
						[/filter]
					[/animate_unit]
					{UNIT $side_number (EoMa_Dimensional_Gate_II) $mehirgateloc.x $mehirgateloc.y (moves,attacks_left,placement,animate=0,0,map_passable,yes)}					 
				[/then]
			)}
		[/then]
		)}
	[/event]
    {MEDITATION_EVENT}
[/unit_type]
